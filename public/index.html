<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertool - Media Processing Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 10px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { 
            color: #1a73e8; 
            margin-bottom: 10px; 
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #e1e5e9; border-radius: 8px; }
        .section h2 { color: #333; margin-bottom: 15px; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .btn { background: #1a73e8; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px; }
        .btn:hover { background: #1557b0; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .status { padding: 15px; border-radius: 5px; margin: 15px 0; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .file-upload { border: 2px dashed #1a73e8; padding: 40px; text-align: center; border-radius: 8px; cursor: pointer; }
        .file-upload:hover { background: #f8f9fa; }
        .file-upload input { display: none; }
        .results { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 15px; }
        .results pre { background: white; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .job-card { border: 1px solid #17a2b8; padding: 15px; margin: 10px 0; border-radius: 5px; background: #f8f9fa; transition: all 0.3s ease; }
        .job-card:hover { box-shadow: 0 2px 8px rgba(23, 162, 184, 0.2); transform: translateY(-1px); }
        .job-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .job-id { color: #17a2b8; font-weight: bold; }
        .job-status { background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; }
        .job-info { line-height: 1.6; }
        .job-note { color: #6c757d; font-size: 0.9em; font-style: italic; margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6; }
        
        /* Tab Navigation Styles */
        .tab-navigation { 
            display: flex; 
            background: #f8f9fa; 
            border-radius: 8px; 
            padding: 5px; 
            margin-bottom: 20px; 
            border: 1px solid #e1e5e9;
            overflow-x: auto;
        }
        .tab-btn { 
            background: transparent; 
            border: none; 
            padding: 12px 20px; 
            margin: 0 2px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 120px;
        }
        .tab-btn:hover { 
            background: #e9ecef; 
            color: #495057;
        }
        .tab-btn.active { 
            background: #1a73e8; 
            color: white; 
            box-shadow: 0 2px 4px rgba(26, 115, 232, 0.3);
        }
        .tab-content { 
            display: none; 
            animation: fadeIn 0.3s ease;
        }
        .tab-content.active { 
            display: block; 
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Speed options styling */
        #speedOptions {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            animation: slideDown 0.3s ease;
        }
        
        #speedOptions label {
            color: #495057;
            font-weight: 600;
        }
        
        #speedMultiplier {
            border: 2px solid #1a73e8;
            background: white;
        }
        
        @keyframes slideDown {
            from { 
                opacity: 0; 
                transform: translateY(-10px); 
                max-height: 0;
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
                max-height: 100px;
            }
        }
        
        /* Crop modal styling */
        #cropModal {
            backdrop-filter: blur(5px);
        }
        
        #cropModal > div {
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid #e1e5e9;
        }
        
        #cropModal h2 {
            color: #1a73e8;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #cropModal .form-group {
            margin-bottom: 20px;
        }
        
        #cropModal input[type="range"] {
            width: 100%;
            margin-top: 5px;
        }
        
        #cropModal .btn {
            margin: 0 10px;
            min-width: 120px;
        }
        
        #cropQualityValue {
            display: inline-block;
            margin-left: 10px;
            font-weight: bold;
            color: #1a73e8;
        }
        
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: bold; }
        tr:hover { background-color: #f5f5f5; }
        
        /* Modal Styles */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7); 
            z-index: 1000; 
            overflow-y: auto;
        }
        .modal-content { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            max-width: 500px; 
            width: 90%; 
            max-height: 90vh;
            overflow-y: auto;
        }
        .close { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            font-size: 24px; 
            cursor: pointer; 
            color: #aaa; 
        }
        .close:hover { color: #000; }
        
        /* MFA QR Code */
        .qrcode-container { 
            text-align: center; 
            margin: 20px 0; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 8px; 
        }
        .qrcode { 
            max-width: 200px; 
            margin: 0 auto; 
        }
        
        /* Role badges */
        .role-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 5px;
        }
        .role-admin { background: #dc3545; color: white; }
        .role-user { background: #28a745; color: white; }
        .role-moderator { background: #ffc107; color: black; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .tab-navigation { flex-direction: column; padding: 10px; }
            .tab-btn { margin: 2px 0; min-width: auto; text-align: center; }
            .modal-content { width: 95%; padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è Convertool</h1>
            <p>Professional Media Processing & Conversion Tool</p>
        </div>

        <!-- Register Section -->
        <div class="section" id="registerSection">
            <h2>üìù Register</h2>
            <div class="form-group">
                <label for="regUsername">Username:</label>
                <input type="text" id="regUsername" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label for="regEmail">Email:</label>
                <input type="email" id="regEmail" placeholder="Enter email">
            </div>
            <div class="form-group">
                <label for="regPassword">Password:</label>
                <input type="password" id="regPassword" placeholder="Enter password">
            </div>
            <div class="form-group">
                <label for="regConfirmPassword">Confirm Password:</label>
                <input type="password" id="regConfirmPassword" placeholder="Confirm password">
            </div>
            <button class="btn" onclick="register()">Register</button>
            <div id="registerStatus"></div>
        </div>

        <!-- Login Section -->
        <div class="section" id="loginSection">
            <h2>üîê Login</h2>
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" placeholder="Enter password">
            </div>
            <div id="mfaSection" style="display: none;">
                <div class="form-group">
                    <label for="mfaCode">MFA Code:</label>
                    <input type="text" id="mfaCode" placeholder="Enter 6-digit code">
                </div>
            </div>
            <button class="btn" onclick="login()" id="loginBtn">Login</button>
            <div id="loginStatus"></div>
        </div>

        <!-- Main Functionality Section -->
        <div id="mainSection" style="display: none;">
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="showTab('upload')">üìÅ Convert & Process</button>
                <button class="tab-btn" onclick="showTab('files')">üìä My Files</button>
                <button class="tab-btn" onclick="showTab('jobs')">‚úÖ Conversion Jobs</button>
                <button class="tab-btn" onclick="showTab('processed')">üé¨ Converted Files</button>
                <button class="tab-btn" onclick="showTab('profile')">üë§ Profile</button>
                <button class="tab-btn" onclick="showTab('users')" id="usersTabBtn" style="display: none;">üë• User Management</button>
                <button class="tab-btn" onclick="showTab('roles')" id="rolesTabBtn" style="display: none;">üîê Role Management</button>
            </div>

            <!-- Convert & Process Tab -->
            <div id="uploadTab" class="tab-content active">
                <div class="section">
                    <h2>üìÅ Upload Files</h2>
                    <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" accept="video/*,audio/*,image/*" onchange="handleFileSelect()">
                        <h3>Click to Select File</h3>
                        <p>Supported: MP4, AVI, MOV, MKV, MP3, WAV, FLAC, AAC, JPG, PNG, GIF</p>
                        <p style="color: #666; font-size: 0.9em;">Maximum file size: 500MB</p>
                    </div>
                    <div id="fileInfo" style="display: none; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 5px;"></div>
                    <button class="btn" onclick="uploadFile()" id="uploadBtn" disabled>Upload File</button>
                    <div id="uploadStatus"></div>
                </div>

                <div class="section">
                    <h2>‚öôÔ∏è Convert & Process</h2>
                    <div class="form-group">
                        <label for="fileSelect">Select File:</label>
                        <select id="fileSelect">
                            <option value="">Select file to convert...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="processType">Conversion Type:</label>
                        <select id="processType" onchange="toggleSpeedOptions()">
                            <option value="">Select conversion type...</option>
                            <option value="speed-change">üé¨ Speed Change</option>
                            <option value="filter">üéµ Audio Filter</option>
                            <option value="stabilise">üé≠ 3D Animation Generation</option>
                        </select>
                    </div>

                    <!-- Speed options (only shown when Speed Change is selected) -->
                    <div id="speedOptions" class="form-group" style="display: none;">
                        <label for="speedMultiplier">Speed Multiplier:</label>
                        <select id="speedMultiplier">
                            <option value="0.2">0.2x (Slow Motion)</option>
                            <option value="0.5">0.5x (Half Speed)</option>
                            <option value="1.5">1.5x (Fast Forward)</option>
                            <option value="2.0">2.0x (Double Speed)</option>
                        </select>
                    </div>
                    <button class="btn" onclick="startProcessing()" id="processBtn" disabled>Start Conversion</button>
                    <div id="processStatus"></div>
                </div>
            </div>

            <!-- My Files Tab -->
            <div id="filesTab" class="tab-content">
                <div class="section">
                    <h2>üìä My Files</h2>
                    <button class="btn" onclick="loadFiles()">Refresh File List</button>
                    <div id="filesList"></div>
                </div>
            </div>

            <!-- Conversion Jobs Tab -->
            <div id="jobsTab" class="tab-content">
                <div class="section">
                    <h2>‚úÖ Conversion Jobs</h2>
                    <button class="btn" onclick="loadCompletedJobs()">Refresh Conversion Jobs</button>
                    <div id="completedJobsList"></div>
                </div>
            </div>

            <!-- Converted Files Tab -->
            <div id="processedTab" class="tab-content">
                <div class="section">
                    <h2>üé¨ Converted Files</h2>
                    <button class="btn" onclick="loadProcessedFiles()">View Converted Files</button>
                    <div id="processedFilesList"></div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profileTab" class="tab-content">
                <div class="section">
                    <h2>üë§ User Profile</h2>
                    <div class="form-group">
                        <label for="profileUsername">Username:</label>
                        <input type="text" id="profileUsername" disabled>
                    </div>
                    <div class="form-group">
                        <label for="profileEmail">Email:</label>
                        <input type="email" id="profileEmail">
                    </div>
                    <div class="form-group">
                        <label for="profileFirstName">First Name:</label>
                        <input type="text" id="profileFirstName">
                    </div>
                    <div class="form-group">
                        <label for="profileLastName">Last Name:</label>
                        <input type="text" id="profileLastName">
                    </div>
                    <button class="btn" onclick="updateProfile()">Update Profile</button>
                    <div id="profileStatus"></div>
                </div>

                <div class="section">
                    <h2>üîê Multi-Factor Authentication</h2>
                    <div id="mfaStatus">
                        <p>MFA Status: <span id="mfaStatusText">Checking...</span></p>
                    </div>
                    <div id="mfaEnableSection" style="display: none;">
                        <div class="qrcode-container">
                            <p>Scan this QR code with your authenticator app:</p>
                            <img id="mfaQrCode" class="qrcode" src="" alt="MFA QR Code">
                            <p>Or enter this secret key manually: <code id="mfaSecret"></code></p>
                        </div>
                        <div class="form-group">
                            <label for="enableMfaCode">Verification Code:</label>
                            <input type="text" id="enableMfaCode" placeholder="Enter 6-digit code">
                        </div>
                        <button class="btn btn-success" onclick="enableMfa()">Enable MFA</button>
                        <button class="btn btn-secondary" onclick="cancelEnableMfa()">Cancel</button>
                    </div>
                    <div id="mfaDisableSection" style="display: none;">
                        <div class="form-group">
                            <label for="disableMfaCode">Verification Code:</label>
                            <input type="text" id="disableMfaCode" placeholder="Enter 6-digit code">
                        </div>
                        <button class="btn btn-danger" onclick="disableMfa()">Disable MFA</button>
                    </div>
                    <div id="mfaActionSection" style="display: none;">
                        <button class="btn" onclick="setupMfa()">Set Up MFA</button>
                    </div>
                </div>

                <div class="section">
                    <h2>üö™ Session Management</h2>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- User Management Tab (Admin only) -->
            <div id="usersTab" class="tab-content">
                <div class="section">
                    <h2>üë• User Management</h2>
                    <button class="btn" onclick="loadUsers()">Refresh Users</button>
                    <div id="usersList">
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Role Management Tab (Admin only) -->
            <div id="rolesTab" class="tab-content">
                <div class="section">
                    <h2>üîê Role Management</h2>
                    <button class="btn" onclick="loadRoles()">Refresh Roles</button>
                    <button class="btn btn-success" onclick="showCreateRoleModal()">Create New Role</button>
                    <div id="rolesList">
                        <table>
                            <thead>
                                <tr>
                                    <th>Role Name</th>
                                    <th>Permissions</th>
                                    <th>Users</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="rolesTableBody">
                                <!-- Roles will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Crop Options Modal -->
    <div id="cropModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCropModal()">&times;</span>
            <h2 id="cropModalTitle">üé¨ Process File: <span id="cropFileName"></span></h2>
            <div class="form-group">
                <label for="cropWidth">Width (pixels):</label>
                <input type="number" id="cropWidth" placeholder="e.g., 800" min="1">
            </div>
            <div class="form-group">
                <label for="cropHeight">Height (pixels):</label>
                <input type="number" id="cropHeight" placeholder="e.g., 600" min="1">
            </div>
            <div class="form-group">
                <label for="cropX">X Position (pixels):</label>
                <input type="number" id="cropX" placeholder="e.g., 0" min="0">
            </div>
            <div class="form-group">
                <label for="cropY">Y Position (pixels):</label>
                <input type="number" id="cropY" placeholder="e.g., 0" min="0">
            </div>
            <div class="form-group">
                <label for="cropFormat">Processing Type:</label>
                <select id="cropFormat">
                    <option value="speed-change">üé¨ Speed Change</option>
                    <option value="filter">üéµ Audio Filter</option>
                    <option value="stabilise">üé≠ 3D Animation Generation</option>
                    <option value="crop">‚úÇÔ∏è Crop</option>
                </select>
            </div>
            <div class="form-group">
                <label for="cropQuality">Quality (JPEG only):</label>
                <input type="range" id="cropQuality" min="1" max="100" value="80">
                <span id="cropQualityValue">80%</span>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="performProcessing()" id="cropButton">üé¨ Process File</button>
                <button class="btn btn-secondary" onclick="closeCropModal()">Cancel</button>
            </div>
            <div id="cropStatus" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Create Role Modal -->
    <div id="createRoleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('createRoleModal')">&times;</span>
            <h2>Create New Role</h2>
            <div class="form-group">
                <label for="newRoleName">Role Name:</label>
                <input type="text" id="newRoleName" placeholder="Enter role name">
            </div>
            <div class="form-group">
                <label for="newRoleDescription">Description:</label>
                <textarea id="newRoleDescription" placeholder="Enter role description"></textarea>
            </div>
            <div class="form-group">
                <label>Permissions:</label>
                <div>
                    <input type="checkbox" id="permUpload" value="upload">
                    <label for="permUpload">Upload Files</label>
                </div>
                <div>
                    <input type="checkbox" id="permProcess" value="process">
                    <label for="permProcess">Process Files</label>
                </div>
                <div>
                    <input type="checkbox" id="permDelete" value="delete">
                    <label for="permDelete">Delete Files</label>
                </div>
                <div>
                    <input type="checkbox" id="permUserManagement" value="user_management">
                    <label for="permUserManagement">User Management</label>
                </div>
                <div>
                    <input type="checkbox" id="permRoleManagement" value="role_management">
                    <label for="permRoleManagement">Role Management</label>
                </div>
            </div>
            <button class="btn btn-success" onclick="createRole()">Create Role</button>
            <div id="createRoleStatus"></div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editUserModal')">&times;</span>
            <h2>Edit User</h2>
            <input type="hidden" id="editUserId">
            <div class="form-group">
                <label for="editUserUsername">Username:</label>
                <input type="text" id="editUserUsername" disabled>
            </div>
            <div class="form-group">
                <label for="editUserEmail">Email:</label>
                <input type="email" id="editUserEmail">
            </div>
            <div class="form-group">
                <label for="editUserRole">Role:</label>
                <select id="editUserRole">
                    <!-- Roles will be populated here -->
                </select>
            </div>
            <div class="form-group">
                <label for="editUserStatus">Status:</label>
                <select id="editUserStatus">
                    <option value="active">Active</option>
                    <option value="suspended">Suspended</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            <button class="btn" onclick="updateUser()">Update User</button>
            <div id="editUserStatus"></div>
        </div>
    </div>

    <script>
        let authToken = null;
        let selectedFile = null;
        let currentUser = null;
        let mfaSetupData = null;
        let currentCropFileId = null;
        let currentCropFileType = null;

        // Check if user is logged in on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedToken = localStorage.getItem('authToken');
            if (savedToken) {
                authToken = savedToken;
                // Verify token is still valid
                verifyToken();
            }
            
            // Set up quality slider
            const qualitySlider = document.getElementById('cropQuality');
            const qualityValue = document.getElementById('cropQualityValue');
            if (qualitySlider && qualityValue) {
                qualitySlider.addEventListener('input', function() {
                    qualityValue.textContent = this.value + '%';
                });
            }
        });

        // Verify token validity
        async function verifyToken() {
            try {
                const response = await fetch('/api/auth/verify', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    showMainInterface();
                } else {
                    localStorage.removeItem('authToken');
                    authToken = null;
                }
            } catch (error) {
                console.error('Token verification failed:', error);
                localStorage.removeItem('authToken');
                authToken = null;
            }
        }

        // Show main interface after login
        function showMainInterface() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('registerSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'block';
            
            // Load user profile
            loadUserProfile();
            
            // Check if user is admin and show admin tabs
            if (currentUser && currentUser.role === 'admin') {
                document.getElementById('usersTabBtn').style.display = 'block';
                document.getElementById('rolesTabBtn').style.display = 'block';
            }
            
            // Load initial data
            loadFiles();
        }

        // Register function
        async function register() {
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;

            if (!username || !email || !password || !confirmPassword) {
                showStatus('registerStatus', 'Please fill in all fields', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showStatus('registerStatus', 'Passwords do not match', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('registerStatus', 'Registration successful! Please check your email for verification.', 'success');
                    // Clear form
                    document.getElementById('regUsername').value = '';
                    document.getElementById('regEmail').value = '';
                    document.getElementById('regPassword').value = '';
                    document.getElementById('regConfirmPassword').value = '';
                } else {
                    showStatus('registerStatus', data.error, 'error');
                }
            } catch (error) {
                showStatus('registerStatus', 'Registration failed: ' + error.message, 'error');
            }
        }

        // Login function
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const mfaCode = document.getElementById('mfaCode').value;

            if (!username || !password) {
                showStatus('loginStatus', 'Please enter username and password', 'error');
                return;
            }

            try {
                const loginData = { username, password };
                if (mfaCode) {
                    loginData.mfaCode = mfaCode;
                }

                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginData)
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.mfaRequired && !mfaCode) {
                        // Show MFA input field
                        document.getElementById('mfaSection').style.display = 'block';
                        document.getElementById('loginBtn').textContent = 'Verify MFA';
                        showStatus('loginStatus', 'Please enter your MFA code', 'info');
                        return;
                    }

                    authToken = data.token;
                    currentUser = data.user;
                    
                    // Save token to localStorage
                    localStorage.setItem('authToken', authToken);
                    
                    showStatus('loginStatus', `Welcome ${username}!`, 'success');
                    showMainInterface();
                } else {
                    showStatus('loginStatus', data.error, 'error');
                    // Reset MFA section if login fails
                    document.getElementById('mfaSection').style.display = 'none';
                    document.getElementById('loginBtn').textContent = 'Login';
                }
            } catch (error) {
                showStatus('loginStatus', 'Login failed: ' + error.message, 'error');
            }
        }

        // Load user profile
        async function loadUserProfile() {
            try {
                const response = await fetch('/api/users/profile', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Populate profile form
                    document.getElementById('profileUsername').value = data.username;
                    document.getElementById('profileEmail').value = data.email;
                    document.getElementById('profileFirstName').value = data.firstName || '';
                    document.getElementById('profileLastName').value = data.lastName || '';
                    
                    // Check MFA status
                    checkMfaStatus();
                }
            } catch (error) {
                console.error('Failed to load user profile:', error);
            }
        }

        // Update user profile
        async function updateProfile() {
            const email = document.getElementById('profileEmail').value;
            const firstName = document.getElementById('profileFirstName').value;
            const lastName = document.getElementById('profileLastName').value;

            try {
                const response = await fetch('/api/users/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, firstName, lastName })
                });

                if (response.ok) {
                    showStatus('profileStatus', 'Profile updated successfully', 'success');
                } else {
                    const data = await response.json();
                    showStatus('profileStatus', data.error, 'error');
                }
            } catch (error) {
                showStatus('profileStatus', 'Profile update failed: ' + error.message, 'error');
            }
        }

        // Check MFA status
        async function checkMfaStatus() {
            try {
                const response = await fetch('/api/auth/mfa-status', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const statusText = document.getElementById('mfaStatusText');
                    const enableSection = document.getElementById('mfaEnableSection');
                    const disableSection = document.getElementById('mfaDisableSection');
                    const actionSection = document.getElementById('mfaActionSection');
                    
                    if (data.enabled) {
                        statusText.textContent = 'Enabled';
                        statusText.style.color = 'green';
                        disableSection.style.display = 'block';
                        enableSection.style.display = 'none';
                        actionSection.style.display = 'none';
                    } else {
                        statusText.textContent = 'Disabled';
                        statusText.style.color = 'red';
                        disableSection.style.display = 'none';
                        
                        if (data.setupData) {
                            // Show setup UI with QR code
                            mfaSetupData = data.setupData;
                            document.getElementById('mfaQrCode').src = data.setupData.qrCode;
                            document.getElementById('mfaSecret').textContent = data.setupData.secret;
                            enableSection.style.display = 'block';
                            actionSection.style.display = 'none';
                        } else {
                            enableSection.style.display = 'none';
                            actionSection.style.display = 'block';
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to check MFA status:', error);
            }
        }

        // Setup MFA
        async function setupMfa() {
            try {
                const response = await fetch('/api/auth/enable-mfa', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    mfaSetupData = data;
                    
                    // Show QR code and verification input
                    document.getElementById('mfaQrCode').src = data.qrCode;
                    document.getElementById('mfaSecret').textContent = data.secret;
                    document.getElementById('mfaEnableSection').style.display = 'block';
                    document.getElementById('mfaActionSection').style.display = 'none';
                } else {
                    const data = await response.json();
                    showStatus('mfaStatus', data.error, 'error');
                }
            } catch (error) {
                showStatus('mfaStatus', 'MFA setup failed: ' + error.message, 'error');
            }
        }

        // Enable MFA
        async function enableMfa() {
            const code = document.getElementById('enableMfaCode').value;
            
            if (!code || code.length !== 6) {
                showStatus('mfaStatus', 'Please enter a valid 6-digit code', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/verify-mfa', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code, secret: mfaSetupData.secret })
                });

                if (response.ok) {
                    showStatus('mfaStatus', 'MFA enabled successfully', 'success');
                    checkMfaStatus();
                } else {
                    const data = await response.json();
                    showStatus('mfaStatus', data.error, 'error');
                }
            } catch (error) {
                showStatus('mfaStatus', 'MFA enable failed: ' + error.message, 'error');
            }
        }

        // Disable MFA
        async function disableMfa() {
            const code = document.getElementById('disableMfaCode').value;
            
            if (!code || code.length !== 6) {
                showStatus('mfaStatus', 'Please enter a valid 6-digit code', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/disable-mfa', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code })
                });

                if (response.ok) {
                    showStatus('mfaStatus', 'MFA disabled successfully', 'success');
                    checkMfaStatus();
                } else {
                    const data = await response.json();
                    showStatus('mfaStatus', data.error, 'error');
                }
            } catch (error) {
                showStatus('mfaStatus', 'MFA disable failed: ' + error.message, 'error');
            }
        }

        // Cancel MFA setup
        function cancelEnableMfa() {
            document.getElementById('mfaEnableSection').style.display = 'none';
            document.getElementById('mfaActionSection').style.display = 'block';
            document.getElementById('enableMfaCode').value = '';
        }

        // Load users (admin only)
        async function loadUsers() {
            try {
                const response = await fetch('/api/users', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const tableBody = document.getElementById('usersTableBody');
                    tableBody.innerHTML = '';
                    
                    data.users.forEach(user => {
                        const row = document.createElement('tr');
                        
                        // Create role badge
                        let roleBadge = '';
                        if (user.role === 'admin') {
                            roleBadge = '<span class="role-badge role-admin">Admin</span>';
                        } else if (user.role === 'moderator') {
                            roleBadge = '<span class="role-badge role-moderator">Moderator</span>';
                        } else {
                            roleBadge = '<span class="role-badge role-user">User</span>';
                        }
                        
                        row.innerHTML = `
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td>${roleBadge}</td>
                            <td>${user.status}</td>
                            <td>
                                <button class="btn" onclick="editUser('${user.id}', '${user.username}', '${user.email}', '${user.role}', '${user.status}')">Edit</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        // Load roles (admin only)
        async function loadRoles() {
            try {
                const response = await fetch('/api/roles', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const tableBody = document.getElementById('rolesTableBody');
                    tableBody.innerHTML = '';
                    
                    // Also populate role dropdown in edit user modal
                    const roleDropdown = document.getElementById('editUserRole');
                    roleDropdown.innerHTML = '';
                    
                    data.roles.forEach(role => {
                        // Add to roles table
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${role.name}</td>
                            <td>${role.permissions.join(', ')}</td>
                            <td>${role.userCount}</td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteRole('${role.id}')">Delete</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                        
                        // Add to role dropdown
                        const option = document.createElement('option');
                        option.value = role.id;
                        option.textContent = role.name;
                        roleDropdown.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load roles:', error);
            }
        }

        // Edit user
        function editUser(id, username, email, role, status) {
            document.getElementById('editUserId').value = id;
            document.getElementById('editUserUsername').value = username;
            document.getElementById('editUserEmail').value = email;
            document.getElementById('editUserRole').value = role;
            document.getElementById('editUserStatus').value = status;
            
            showModal('editUserModal');
        }

        // Update user
        async function updateUser() {
            const id = document.getElementById('editUserId').value;
            const email = document.getElementById('editUserEmail').value;
            const role = document.getElementById('editUserRole').value;
            const status = document.getElementById('editUserStatus').value;

            try {
                const response = await fetch(`/api/users/${id}/role`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, role, status })
                });

                if (response.ok) {
                    showStatus('editUserStatus', 'User updated successfully', 'success');
                    closeModal('editUserModal');
                    loadUsers();
                } else {
                    const data = await response.json();
                    showStatus('editUserStatus', data.error, 'error');
                }
            } catch (error) {
                showStatus('editUserStatus', 'User update failed: ' + error.message, 'error');
            }
        }

        // Create role
        async function createRole() {
            const name = document.getElementById('newRoleName').value;
            const description = document.getElementById('newRoleDescription').value;
            
            // Get selected permissions
            const permissions = [];
            if (document.getElementById('permUpload').checked) permissions.push('upload');
            if (document.getElementById('permProcess').checked) permissions.push('process');
            if (document.getElementById('permDelete').checked) permissions.push('delete');
            if (document.getElementById('permUserManagement').checked) permissions.push('user_management');
            if (document.getElementById('permRoleManagement').checked) permissions.push('role_management');

            if (!name) {
                showStatus('createRoleStatus', 'Please enter a role name', 'error');
                return;
            }

            try {
                const response = await fetch('/api/roles', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, description, permissions })
                });

                if (response.ok) {
                    showStatus('createRoleStatus', 'Role created successfully', 'success');
                    closeModal('createRoleModal');
                    loadRoles();
                    
                    // Clear form
                    document.getElementById('newRoleName').value = '';
                    document.getElementById('newRoleDescription').value = '';
                    document.getElementById('permUpload').checked = false;
                    document.getElementById('permProcess').checked = false;
                    document.getElementById('permDelete').checked = false;
                    document.getElementById('permUserManagement').checked = false;
                    document.getElementById('permRoleManagement').checked = false;
                } else {
                    const data = await response.json();
                    showStatus('createRoleStatus', data.error, 'error');
                }
            } catch (error) {
                showStatus('createRoleStatus', 'Role creation failed: ' + error.message, 'error');
            }
        }

        // Delete role
        async function deleteRole(roleId) {
            if (!confirm('Are you sure you want to delete this role? Users with this role will be assigned the default user role.')) {
                return;
            }

            try {
                const response = await fetch(`/api/roles/${roleId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    showStatus('rolesList', 'Role deleted successfully', 'success');
                    loadRoles();
                } else {
                    const data = await response.json();
                    showStatus('rolesList', data.error, 'error');
                }
            } catch (error) {
                showStatus('rolesList', 'Role deletion failed: ' + error.message, 'error');
            }
        }

        // Show modal
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Show create role modal
        function showCreateRoleModal() {
            showModal('createRoleModal');
        }

        // Logout
        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('registerSection').style.display = 'block';
            document.getElementById('mainSection').style.display = 'none';
            
            // Reset login form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('mfaCode').value = '';
            document.getElementById('mfaSection').style.display = 'none';
            document.getElementById('loginBtn').textContent = 'Login';
            
            showStatus('loginStatus', 'Logged out successfully', 'info');
        }

        // Show status
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => element.innerHTML = '', 5000);
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to clicked button
            const activeButton = event.target;
            activeButton.classList.add('active');
            
            // Load data for the selected tab
            switch(tabName) {
                case 'files':
                    loadFiles();
                    break;
                case 'jobs':
                    loadCompletedJobs();
                    break;
                case 'processed':
                    loadProcessedFiles();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'roles':
                    loadRoles();
                    break;
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let i = 0; i < modals.length; i++) {
                if (event.target == modals[i]) {
                    modals[i].style.display = 'none';
                }
            }
        }

        // ============ FILE HANDLING FUNCTIONS ============

        // Select file
        function handleFileSelect() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (file) {
                const fileSizeMB = file.size / 1024 / 1024;
                const maxSizeMB = 500;
                
                if (fileSizeMB > maxSizeMB) {
                    showStatus('fileInfo', `‚ùå File too large! Current: ${fileSizeMB.toFixed(2)} MB, Maximum allowed: ${maxSizeMB} MB`, 'error');
                    document.getElementById('uploadBtn').disabled = true;
                    return;
                }

                selectedFile = file;
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('fileInfo').innerHTML = `
                    <strong>Selected File:</strong> ${file.name}<br>
                    <strong>Size:</strong> ${fileSizeMB.toFixed(2)} MB<br>
                    <strong>Type:</strong> ${file.type}<br>
                    <span style="color: green;">‚úÖ File size meets requirements</span>
                `;
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        // Upload file
        async function uploadFile() {
            if (!selectedFile) {
                showStatus('uploadStatus', 'Please select a file first', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('media', selectedFile);

            try {
                showStatus('uploadStatus', 'Uploading...', 'info');

                const response = await fetch('/api/media/upload', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('uploadStatus', `File uploaded successfully! File ID: ${data.fileId}`, 'success');
                    loadFiles();
                } else {
                    showStatus('uploadStatus', data.error, 'error');
                }
            } catch (error) {
                showStatus('uploadStatus', 'Upload failed: ' + error.message, 'error');
            }
        }

        // Start conversion
        async function startProcessing() {
            const fileId = document.getElementById('fileSelect').value;
            const processType = document.getElementById('processType').value;

            if (!fileId || !processType) {
                showStatus('processStatus', 'Please select file and conversion type', 'error');
                return;
            }

            let endpoint = '';
            let requestData = {};

            if (processType === 'speed-change') {
                endpoint = `/api/media/process-video/${fileId}`;
                const speedMultiplier = document.getElementById('speedMultiplier').value;
                requestData = { 
                    processType: 'speed-change',
                    speedMultiplier: parseFloat(speedMultiplier)
                };
            } else if (processType === 'filter') {
                endpoint = `/api/media/process-audio/${fileId}`;
                requestData = { processType: 'filter' };
            } else if (processType === 'stabilise') {
                endpoint = '/api/media/generate-3d-animation';
                requestData = { duration: 30 };
            }

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('processStatus', `Conversion started! Job ID: ${data.jobId}`, 'success');
                } else {
                    showStatus('processStatus', data.error, 'error');
                }
            } catch (error) {
                showStatus('processStatus', 'Conversion failed: ' + error.message, 'error');
            }
        }

        // Load file list
        async function loadFiles() {
            try {
                const response = await fetch('/api/media/files', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    const fileSelect = document.getElementById('fileSelect');
                    fileSelect.innerHTML = '<option value="">Select file to process...</option>';

                    const filesList = document.getElementById('filesList');
                    filesList.innerHTML = '<h3>My Files</h3>';

                    if (data.files.length === 0) {
                        filesList.innerHTML += '<p>No files found</p>';
                        return;
                    }

                    data.files.forEach(file => {
                        // Add to process selector
                        const option = document.createElement('option');
                        option.value = file.id;
                        option.textContent = `${file.original_filename} (${(file.file_size / 1024 / 1024).toFixed(2)} MB)`;
                        fileSelect.appendChild(option);

                        // Add to file list with crop functionality
                        const fileDiv = document.createElement('div');
                        fileDiv.style.cssText = 'border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px;';
                        
                        // Check if file is an image or video for crop functionality
                        const isImage = file.file_type === 'image';
                        const isVideo = file.file_type === 'video';
                        const canCrop = isImage || isVideo;
                        
                        fileDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <strong>File ID:</strong> ${file.id}<br>
                                    <strong>Filename:</strong> ${file.original_filename}<br>
                                    <strong>Size:</strong> ${(file.file_size / 1024 / 1024).toFixed(2)} MB<br>
                                    <strong>Type:</strong> ${file.file_type || 'unknown'}
                                </div>
                                <div style="text-align: right;">
                                    ${canCrop ? `
                                        <button class="btn" onclick="showCropOptions('${file.id}', '${file.original_filename}', '${file.file_type}')" style="margin-bottom: 5px;">
                                            ‚úÇÔ∏è ${isImage ? 'Crop Image' : 'Crop Video'}
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-danger" onclick="deleteFile('${file.id}')">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        `;
                        filesList.appendChild(fileDiv);
                    });

                    document.getElementById('processBtn').disabled = false;
                }
            } catch (error) {
                console.error('Failed to load files:', error);
            }
        }

        // Load processed files list
        async function loadProcessedFiles() {
            try {
                const response = await fetch('/api/media/processed-files', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    const processedFilesList = document.getElementById('processedFilesList');
                    processedFilesList.innerHTML = '<h3>üé¨ Processed Files</h3>';
                    
                    if (data.processedFiles.length === 0) {
                        processedFilesList.innerHTML += '<p>No processed files found</p>';
                        return;
                    }

                    processedFilesList.innerHTML += `
                        <div class="status info" style="margin-bottom: 20px;">
                            <strong>üìä Summary:</strong> Found ${data.totalFiles} processed files
                            <br><strong>üìÅ Output Directory:</strong> ${data.processedDir}
                        </div>
                    `;
                    
                    data.processedFiles.forEach(file => {
                        // Determine processing type from filename
                        let processType = 'Unknown';
                        let originalName = file.original_filename;
                        let icon = 'üìÑ';
                        
                        if (file.original_filename.startsWith('cropped_')) {
                            processType = 'Image Cropping';
                            originalName = file.original_filename.replace('cropped_', '').replace(/_\d+\.\w+$/, '');
                            icon = '‚úÇÔ∏è';
                        } else if (file.original_filename.startsWith('resized_')) {
                            processType = 'Image Resizing';
                            originalName = file.original_filename.replace('resized_', '').replace(/_\d+\.\w+$/, '');
                            icon = 'üñºÔ∏è';
                        } else if (file.original_filename.startsWith('processed_')) {
                            processType = 'Media Processing';
                            originalName = file.original_filename.replace('processed_', '').replace(/_\d+\.\w+$/, '');
                            icon = 'üé¨';
                        }
                        
                        // Get file extension
                        const fileExt = file.original_filename.split('.').pop().toUpperCase();
                        
                        const fileDiv = document.createElement('div');
                        fileDiv.style.cssText = 'border: 1px solid #28a745; padding: 20px; margin: 15px 0; border-radius: 8px; background: #f8fff9; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
                        fileDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-size: 1.2em; margin-bottom: 10px;">
                                        ${icon} <strong>${processType}</strong>
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <strong>üìÑ Processed File:</strong> ${file.original_filename}
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <strong>üìÅ Original Name:</strong> ${originalName}
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <strong>üíæ File Size:</strong> ${(file.size / 1024).toFixed(2)} KB
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <strong>üìÖ Created:</strong> ${new Date(file.created).toLocaleString()}
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <strong>üîß File Type:</strong> ${file.file_type || 'Unknown'}
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <strong>üìÇ Format:</strong> ${fileExt}
                                    </div>
                                </div>
                                <div style="text-align: right; margin-left: 20px;">
                                    <button class="btn btn-success" onclick="downloadFile('${file.file_path}', '${file.original_filename}')" style="margin-bottom: 5px;">
                                        ‚¨áÔ∏è Download
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteProcessedFile('${file.id}')">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        `;
                        processedFilesList.appendChild(fileDiv);
                    });
                }
            } catch (error) {
                console.error('Failed to load processed files:', error);
                const processedFilesList = document.getElementById('processedFilesList');
                processedFilesList.innerHTML = '<h3>üé¨ Processed Files</h3><div class="status error">Failed to load processed files: ' + error.message + '</div>';
            }
        }

        // Load completed jobs list
        async function loadCompletedJobs() {
            try {
                const response = await fetch('/api/media/completed-jobs', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    const completedJobsList = document.getElementById('completedJobsList');
                    completedJobsList.innerHTML = '<h3>Completed Jobs</h3>';
                    
                    if (data.completedJobs.length === 0) {
                        completedJobsList.innerHTML += '<p>No conversion jobs found</p>';
                        return;
                    }

                    completedJobsList.innerHTML += `<p><strong>Total Conversion Jobs:</strong> ${data.totalJobs}</p>`;
                    
                    data.completedJobs.forEach(job => {
                        const jobDiv = document.createElement('div');
                        jobDiv.className = 'job-card';
                        
                        const processTypeLabel = {
                            'speed-change': 'üé¨ Speed Change',
                            'filter': 'üéµ Audio Filter',
                            'stabilise': 'üé≠ 3D Animation Generation'
                        }[job.processType] || job.processType;
                        
                        const duration = job.duration ? `${(job.duration / 1000).toFixed(1)}s` : 'N/A';
                        
                        // Add speed multiplier info for speed change jobs
                        let speedInfo = '';
                        if (job.processType === 'speed-change' && job.speedMultiplier) {
                            speedInfo = `<br><strong>Speed Multiplier:</strong> ${job.speedMultiplier}x`;
                        }
                        
                        jobDiv.innerHTML = `
                            <div class="job-header">
                                <span class="job-id">Job ID: ${job.id}</span>
                                <span class="job-status">${job.status}</span>
                            </div>
                            <div class="job-info">
                                <strong>Process Type:</strong> ${processTypeLabel}${speedInfo}<br>
                                <strong>Original File:</strong> ${job.originalFilename}<br>
                                <strong>Start Time:</strong> ${new Date(job.startTime).toLocaleString()}<br>
                                <strong>Completion Time:</strong> ${new Date(job.completionTime).toLocaleString()}<br>
                                <strong>Processing Duration:</strong> ${duration}
                            </div>
                            <div class="job-note">
                                No output files saved - processing completed in memory
                            </div>
                        `;
                        completedJobsList.appendChild(jobDiv);
                    });
                }
            } catch (error) {
                console.error('Failed to load completed jobs:', error);
            }
        }

        // Crop functionality
        function showCropOptions(fileId, fileName, fileType) {
            currentCropFileId = fileId;
            currentCropFileType = fileType;
            document.getElementById('cropFileName').textContent = fileName;
            document.getElementById('cropModal').style.display = 'block';
            
            // Update modal title and button based on file type
            const modalTitle = document.getElementById('cropModalTitle');
            const cropButton = document.getElementById('cropButton');
            if (modalTitle) {
                modalTitle.textContent = `üé¨ Process ${fileType === 'video' ? 'Video' : 'Image'}: ${fileName}`;
            }
            if (cropButton) {
                cropButton.textContent = 'üé¨ Process File';
            }
            
            // Reset form values
            document.getElementById('cropWidth').value = '';
            document.getElementById('cropHeight').value = '';
            document.getElementById('cropX').value = '0';
            document.getElementById('cropY').value = '0';
            document.getElementById('cropFormat').value = 'crop';
            document.getElementById('cropQuality').value = '80';
            document.getElementById('cropQualityValue').textContent = '80%';
            document.getElementById('cropStatus').innerHTML = '';
        }

        function closeCropModal() {
            document.getElementById('cropModal').style.display = 'none';
            currentCropFileId = null;
        }

        async function performProcessing() {
            if (!currentCropFileId) {
                showStatus('cropStatus', 'No file selected for processing', 'error');
                return;
            }

            const processType = document.getElementById('cropFormat').value;
            
            // Only validate crop parameters if crop is selected
            if (processType === 'crop') {
                const width = parseInt(document.getElementById('cropWidth').value);
                const height = parseInt(document.getElementById('cropHeight').value);
                const x = parseInt(document.getElementById('cropX').value);
                const y = parseInt(document.getElementById('cropY').value);
                const quality = parseInt(document.getElementById('cropQuality').value);

                if (!width || !height || width <= 0 || height <= 0) {
                    showStatus('cropStatus', 'Please enter valid width and height for cropping', 'error');
                    return;
                }

                if (x < 0 || y < 0) {
                    showStatus('cropStatus', 'X and Y positions must be non-negative for cropping', 'error');
                    return;
                }
            }

            try {
                const processType = document.getElementById('cropFormat').value;
                showStatus('cropStatus', `Processing ${processType} request...`, 'info');

                // Choose endpoint based on processing type
                let endpoint;
                let requestData = {};
                
                if (processType === 'speed-change') {
                    endpoint = `/api/media/process-video/${currentCropFileId}`;
                    requestData = { 
                        processType: 'speed-change',
                        speedMultiplier: 1.5
                    };
                } else if (processType === 'filter') {
                    endpoint = `/api/media/process-audio/${currentCropFileId}`;
                    requestData = { processType: 'filter' };
                } else if (processType === 'stabilise') {
                    endpoint = '/api/media/generate-3d-animation';
                    requestData = { duration: 30 };
                } else if (processType === 'crop') {
                    // Use crop endpoint based on file type
                    const isVideo = currentCropFileType === 'video';
                    const width = parseInt(document.getElementById('cropWidth').value);
                    const height = parseInt(document.getElementById('cropHeight').value);
                    const x = parseInt(document.getElementById('cropX').value);
                    const y = parseInt(document.getElementById('cropY').value);
                    const quality = parseInt(document.getElementById('cropQuality').value);
                    
                    endpoint = isVideo ? `/api/media/crop-video/${currentCropFileId}` : `/api/media/crop-image/${currentCropFileId}`;
                    requestData = {
                        width,
                        height,
                        x,
                        y,
                        format: 'jpeg',
                        quality
                    };
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (response.ok) {
                    const processType = document.getElementById('cropFormat').value;
                    let successMessage = '';
                    
                    if (processType === 'crop') {
                        const fileType = currentCropFileType === 'video' ? 'Video' : 'Image';
                        successMessage = `${fileType} cropped successfully! Output: ${data.filename}`;
                    } else if (processType === 'speed-change') {
                        successMessage = `Video speed change completed! Job ID: ${data.jobId}`;
                    } else if (processType === 'filter') {
                        successMessage = `Audio filter applied! Job ID: ${data.jobId}`;
                    } else if (processType === 'stabilise') {
                        successMessage = `3D animation generation completed! Job ID: ${data.jobId}`;
                    }
                    
                    showStatus('cropStatus', successMessage, 'success');
                    setTimeout(() => {
                        closeCropModal();
                        loadFiles();
                    }, 2000);
                } else {
                    showStatus('cropStatus', data.error || 'Processing failed', 'error');
                }
            } catch (error) {
                showStatus('cropStatus', 'Crop failed: ' + error.message, 'error');
            }
        }

        // Delete file function
        async function deleteFile(fileId) {
            if (!confirm('Are you sure you want to delete this file? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/media/delete-file/${fileId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    showStatus('filesList', 'File deleted successfully', 'success');
                    loadFiles();
                } else {
                    const data = await response.json();
                    showStatus('filesList', data.error || 'Delete failed', 'error');
                }
            } catch (error) {
                showStatus('filesList', 'Delete failed: ' + error.message, 'error');
            }
        }

        // Download processed file
        async function downloadFile(filePath, filename) {
            try {
                const response = await fetch(`/api/media/download/${encodeURIComponent(filePath)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const data = await response.json();
                    showStatus('processedFilesList', data.error || 'Download failed', 'error');
                }
            } catch (error) {
                showStatus('processedFilesList', 'Download failed: ' + error.message, 'error');
            }
        }

        // Delete processed file
        async function deleteProcessedFile(fileId) {
            if (!confirm('Are you sure you want to delete this processed file? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/media/delete-file/${fileId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    showStatus('processedFilesList', 'Processed file deleted successfully', 'success');
                    loadProcessedFiles();
                } else {
                    const data = await response.json();
                    showStatus('processedFilesList', data.error || 'Delete failed', 'error');
                }
            } catch (error) {
                showStatus('processedFilesList', 'Delete failed: ' + error.message, 'error');
            }
        }

        // Toggle speed options visibility
        function toggleSpeedOptions() {
            const processType = document.getElementById('processType').value;
            const speedOptions = document.getElementById('speedOptions');
            
            if (processType === 'speed-change') {
                speedOptions.style.display = 'block';
            } else {
                speedOptions.style.display = 'none';
            }
        }
    </script>
</body>
</html>